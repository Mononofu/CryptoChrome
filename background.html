<html>
<head>
<script>

function plugin0() {
  return document.getElementById('plugin');
}

plugin = plugin0;

function saveToClipboard(text) {
  // now save it to clipboard
  var textarea = document.getElementById("tmp-clipboard");

  // now we put the message in the textarea
  textarea.value = text;

  // and copy the text from the textarea
  textarea.select();
  document.execCommand("copy", false, null);
}

function replaceText(tab_id, next_txt) {
  chrome.tabs.sendRequest(tab_id, {cmd: "replace_selected", text: next_txt}, function() {});
}

function encryptText(clear_txt) {
  if(clear_txt != "") {
    var recipient = prompt("Please enter the recipients email","");
    return plugin().encrypt(recipient, clear_txt);
  }
  return "";
}

function decryptText(cipther_txt) {
  return plugin().decrypt(cipther_txt);
}

function clearsignText(clear_txt) {
  return plugin().clearsign(clear_txt);
}

function encryptSignText (clear_txt) {
  if(clear_txt != "") {
    var recipient = prompt("Please enter the recipients email","");
    return plugin().encrypt_sign(recipient, clear_txt);
  }
  return "";
}

function withTabSelection (tab, processor, replace) {
  responseHandler = replace ? replaceText.bind(null, tab.id) : saveToClipboard;

  chrome.tabs.executeScript(tab.id, {"file": "content_script.js"}, function() {
    chrome.tabs.sendRequest(tab.id, {cmd: "get_selected"}, function(response) {
      responseHandler(processor(response.msg));
    });
  });
}

function load()
{
  // add entry to context menu
  console.log( chrome.contextMenus.create({"title": "Encrypt", "contexts":["selection"], "onclick": function(info, tab) {
    withTabSelection(tab, encryptText, info.editable);
  } }) );
  console.log( chrome.contextMenus.create({"title": "Clearsign", "contexts":["selection"], "onclick": function(info, tab) {
    withTabSelection(tab, clearsignText, info.editable);
  } }) );
  console.log( chrome.contextMenus.create({"title": "Encrypt && Sign", "contexts":["selection"], "onclick": function(info, tab) {
    withTabSelection(tab, encryptSignText, info.editable);
  } }) );
  console.log( chrome.contextMenus.create({"title": "Decrypt", "contexts":["selection"], "onclick": function(info, tab) {
    withTabSelection(tab, decryptText, info.editable);
  } }) );
}

</script>

</head>
<body onload="load()">

<embed id="plugin" type="application/x-cryptochrome">
<textarea id="tmp-clipboard"></textarea>

</body>
</html>